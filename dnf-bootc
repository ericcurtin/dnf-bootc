#!/bin/bash

set -eu -o pipefail

if [ "$EUID" -ne 0 ]; then
  echo "Error: This command has to be run with superuser privileges (under the root user on most systems)." >&2
  exit 1
fi

if [ -e "/var/Containerfile" ]; then
  if [ ! -e "/var/.Containerfile" ]; then
    echo "Local modifications detected to os Containerfile" >&2
    exit 2
  fi

  if ! cmp -s /var/Containerfile /var/.Containerfile; then
    echo "Local modifications detected to os Containerfile, changes made outside dnf-bootc" >&2
    exit 3
  fi
fi

if ! mount | grep -q "overlay on /usr type"; then
  bootc usr-overlay
fi

exec dnf --setopt=pluginpath=/var/dnf-plugins/ $*

